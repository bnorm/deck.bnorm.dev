Copied from https://github.com/saket/extended-spans
